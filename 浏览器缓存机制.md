# 浏览器缓存机制

## 浏览器缓存规则

​	对于浏览器端的缓存来讲，这些规则是在HTTP协议头和HTML页面的Meta标签中定义的。他们分别从**新鲜度**和**校验值**两个维度来规定浏览器是否可以直接使用缓存中的副本，还是需要去源服务器获取更新的版本。

　　**新鲜度（过期机制）**：也就是缓存副本有效期。一个缓存副本必须满足以下条件，浏览器会认为它是有效的，足够新的：

　　　　1. 含有完整的过期时间控制头信息（HTTP协议报头），并且仍在有效期内；

　　　　2. 浏览器已经使用过这个缓存副本，并且在一个会话中已经检查过新鲜度；

　　满足以上两个情况的一种，浏览器会直接从缓存中获取副本并渲染。

　　**校验值（验证机制）：**服务器返回资源的时候有时在控制头信息带上这个资源的实体标签Etag（Entity Tag），它可以用来作为浏览器再次请求过程的校验标识。如过发现校验标识不匹配，说明资源已经被修改或过期，浏览器需求重新获取资源内容。



## HTTP协议

HTTP消息由客户端到服务器的请求和服务器到客户端的响应组成，请求消息和响应消息都是由开始行(报头的第一行)（请求：请求行；响应：状态行），消息报头（多个报头域）（可选），空行（CRLF回车），消息正文（可选）组成

### 开始行

#### 请求行：Method Request-URI HTTP-version CRLF（回车）

eg：GET /powerdesigner-web/rqm/command/RQMImportCommand.js HTTP/1.1

Method: GET(获取资源) POST（提交表单） HEAD（请求获取接口的相应消息报头） PUT（请求服务器存储） DELETE（删除接口所标识的资源） TRACE CONNECT OPTIONS

#### 状态行：HTTP-Version Status-Code Reason-Phrase CRLF

eg：HTTP/1.1 200 OK

Status-Code服务器发回的响应代码：

第一位表示响应类别

1：指示信息--表示请求已接收，继续处理

2：成功--表示请求已经被成功接收、理解、接受 

3：重定向--要完成请求必须进行更进一步的操作

4：客户端错误--请求有语法错误或请求无法实现

5：服务器端错误--服务器未能实现合法的请求

Reason-Phrase表示状态代码的文本描述

eg：

200 OK //客户端请求成功

400 Bad Request //客户端请求有语法错误，不能被服务器所理解

401 Unauthorized //请求未经授权，这个状态代码必须和WWW-Authenticate报头域一起使用

403 Forbidden //服务器收到请求，但是拒绝提供服务

404 Not Found //请求资源不存在，输入了错误的URL

500 Internal Server Error //服务器发生不可预期的错误

503 Server Unavailable //服务器当前不能处理客户端的请求，一段时间后可能恢复正常

### 消息报头

消息报头由多行报头域组成，每行报头域都包括报头域名称： 对应取值，报头域种类有普通报头域、请求报头域、响应报头域、实体报头域

1. 普通报头

   1. Cache-Control  用于指定缓存指令，缓存指令是单向的（响应中出现的缓存指令在请求中未必会出现），且是独立的（一个消息的缓存指令不会影响另一个消息处理的缓存机制），通常在响应消息的响应报头中

      eg. Cache-Control: public, max-age=0

   2. date表示消息产生的日期和时间

   3. Connection允许发送制定连接的选项，连续或关闭，关闭即通知服务器再响应完成后关闭连接

      eg. Connection: keep-alive

2. 请求报头

   请求报头允许客户端想服务端传递请求的附加信息以及客户端自身的信息

   1. Accept用于指定客户端接收消息类型

      eg. Accept: text/plain, */*; q=0.01

      eg. Accept：image/gif，表明客户端希望接受GIF图象格式的资源

   2. Accept-Charset用于指定客户端接受的字符集，缺省表示任何字符集都可以接受

   3. Accept-Encoding用于指定客户端接受的内容编码

      eg. Accept-Encoding: gzip, deflate, br

   4. Accept-Language用于指定客户端接受的自然语言

      eg. Accept-Language: en-US,en;q=0.9

   5. Authorization用于证明客户端有权查看某资源，当服务器响应401未授权时可发送包含Authoritarian请求报头域的请求，要求服务器验证。

   6. Host(发送请求时必须有该报头域)用于指定被请求资源的Internet主机和端口号(缺省端口号80)

      eg. Host: localhost:3030

      eg. Host: www.baidu.com

   7. User-Agent如果浏览器有这个报头域，那客户端就可以将OS、浏览器等属性告诉服务器

   一个完整的请求报头Request Header举例：

   GET /powerdesigner-views/editor/rqm/command/RQMImportCommand.js HTTP/1.1
   Host: localhost:3030
   Connection: keep-alive
   Accept: text/plain, */*; q=0.01
   X-Requested-With: XMLHttpRequest
   User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.121 Safari/537.36
   Referer: http://localhost:3030/powerdesigner-web/resources/index.html
   Accept-Encoding: gzip, deflate, br
   Accept-Language: en-US,en;q=0.9
   Cookie: JSESSIONID=ACB5D532571D3ED59D3F0F843319460F; Idea-a7897436=c9dc6854-345f-4222-9a02-b82358064eac; POWER_DESIGNER_LOCALE=en; POWER_DESIGNER_EDITLOCALE=main

3. 响应报头

   响应报头允许服务器传递不能放在状态行中的附加响应信息，以及关于服务器的信息和对Request-URI所标识的资源进行下一步访问的信息。

   1. Location用于重定向接收者到一个新的位置，常用于更换域名时

   2. Server包含了服务器用来处理请求的软件信息 对应于请求报头的User-Agent请求报头域

      eg. Server: BWS/1.1

      eg. Server：Apache-Coyote/1.1

   3. WWW-Authenticate仅包含在401响应消息：客户端收到401响应消息->发送Authorization报头域请求服务器进行验证->服务器响应报头包含WWW-Authenticate响应报头域

4. 实体报头

   请求和响应消息都可以传送一个实体。一个实体由实体报头域和实体正文组成，但并不是说实体报头域和实体正文要在一起发送，可以只发送实体报头域。实体报头定义了关于实体正文（eg：有无实体正文）和请求所标识的资源的元信息。

   1. Content-Encoding被用作媒体类型的修饰符，它的值指示了已经被应用到实体正文的附加内容的编码，因而要获得Content-Type报头域中所引用的媒体类型，必须采用相应的解码机制。Content-Encoding这样用于记录文档的压缩方法

      eg：Content-Encoding：gzip

   2. Content-Language自然语言

   3. Content-Length用于知名实体正文的长度，十进制存储字节数

   4. Content-Type用于知名发送给接收者的实体正文的媒体类型

   5. Last-Modified资源的最后修改日期和时间

   6. Expires给出响应过期的日期时间，为了让代理服务器或浏览器在一段时间以后更新缓存中(再次访问曾访问过的页面时，直接从缓存中加载，缩短响应时间和降低服务器负载)的页面，我们可以使用Expires实体报头域指定页面过期的时间。

      eg：Expires：Thu，15 Sep 2006 16:23:12 GMT
      HTTP1.1的客户端和缓存必须将其他非法的日期格式（包括0）看作已经过期。eg：为了让浏览器不要缓存页面，我们也可以利用Expires实体报头域，设置为0

## 浏览器缓存的控制

| 规则   | 报头域名称        | 报头域值      | 类型     | 作用                                                         |
| ------ | ----------------- | ------------- | -------- | :----------------------------------------------------------- |
| 新鲜度 | Pragma            | no-cache      | Response | 不许用缓存，每次都从服务器拉数据。http1.0version,新版本没有，为了向下兼容还是要带 |
| 新鲜度 | Expires           | 时间戳        | Response | 过期时间，还没过期就用缓存，过期就发请求。http1.0version，时间轴是服务器上的时间，可能会与客户端时间不同因此弃用，2.0version用Cache-Control: max_age=x秒代替 |
| 新鲜度 | Cache-control     | no-cache      | Response | 忽略缓存副本，每次发请求拉资源，但是有缓存，只是不用         |
| 新鲜度 | Cache-control     | no-store      | Response | 不保留任何缓存副本                                           |
| 新鲜度 | Cache-control     | max-age=x秒   | Response | 缓存副本的有效时间                                           |
| 新鲜度 | Cache-control     | public        | Response | 所有人都能缓存该资源                                         |
| 新鲜度 | Cache-control     | private       | Response | 特定用户/实体能缓存资源                                      |
| 新鲜度 | Last-Modified     | 时间戳        | Response | 资源最后修改时间,配合下面这个报头域使用                      |
| 新鲜度 | If-Modified-Since | 时间戳        | Request  | 其值为上次响应头的Last-Modified值，再次向web服务器请求时带上头If-Modified-Since。web服务器收到请求后发现有头If-Modified-Since则与被请求资源的最后修改时间进行比对。若最后修改时间较新，说明资源又被改动过，则响应整片资源内容（写在响应消息包体内），包括更新Last-Modified的值，HTTP 200；若最后修改时间较旧，说明资源无新修改，则响应HTTP 304(无需包体，节省浏览)，告知浏览器继续使用所保存的cache |
| 校验值 | ETAG              | "fd562733..." | Response | 告诉浏览器当前资源在服务器的唯一标识符                       |
| 校验值 | If-non-match      | "fd562733..." | Request  | 当资源过期时（使用Cache-Control标识的max-age），发现资源具有Etage声明，则再次向web服务器请求时带上头If-None-Match（Etag的值）。web服务器收到请求后发现有头If-None-Match则与被请求资源的相应校验串进行比对，决定返回200或304 |

